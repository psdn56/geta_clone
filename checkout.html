<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout - Pankaj Footwear</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">
  <div class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-2xl font-bold mb-4">Checkout</h2>
    <form id="checkoutForm" class="space-y-4">
      <input type="text" name="name" placeholder="Full Name" class="w-full border p-2 rounded" required>
      <input type="email" name="email" placeholder="Email" class="w-full border p-2 rounded" required>
      <input type="text" name="phone" placeholder="Phone Number" class="w-full border p-2 rounded" required>
      <input type="text" name="pincode" placeholder="Pincode" class="w-full border p-2 rounded" required>
      <input type="text" name="city" placeholder="City" class="w-full border p-2 rounded" required>
      <input type="text" name="state" placeholder="State" class="w-full border p-2 rounded" required>

      <!-- Separate address fields -->
      <input type="text" name="floor" placeholder="Floor / Flat No." class="w-full border p-2 rounded" required>
      <input type="text" name="street" placeholder="Street Name" class="w-full border p-2 rounded" required>
      <input type="text" name="area" placeholder="Area / Landmark" class="w-full border p-2 rounded" required>

      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Submit Order</button>
    </form>
    <p id="responseMsg" class="mt-4 text-center text-sm text-gray-700"></p>
  </div>

  <!-- Auto-detect City/State from Pincode -->
  <script>
    const pincodeInput = document.querySelector('input[name="pincode"]');
    const cityInput = document.querySelector('input[name="city"]');
    const stateInput = document.querySelector('input[name="state"]');

    pincodeInput.addEventListener("blur", async () => {
      const pin = pincodeInput.value.trim();
      if (pin.length === 6) {
        try {
          const res = await fetch(`https://api.postalpincode.in/pincode/${pin}`);
          const data = await res.json();
          if (data[0].Status === "Success") {
            const postOffice = data[0].PostOffice[0];
            cityInput.value = postOffice.District;
            stateInput.value = postOffice.State;
          } else {
            cityInput.value = "";
            stateInput.value = "";
            alert("Invalid pincode or data not found.");
          }
        } catch (err) {
          alert("Failed to fetch location. Please check your internet connection.");
        }
      }
    });
  </script>

  <!-- Function to Generate Order ID -->
  <script>
    function generateOrderId(phone) {
      const now = new Date();
      const year = now.getFullYear().toString().slice(-2);
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const time = now.toTimeString().slice(0, 8).replace(":", "").replace(":", "");
      const last4PhoneDigits = phone.slice(-4);

      return `OID${year}${day}${month}${last4PhoneDigits}${time}`;
    }

    const form = document.getElementById("checkoutForm");
    const responseMsg = document.getElementById("responseMsg");

    const sheetURL = "https://script.google.com/macros/s/AKfycbxqbhGcaxZwX-wHeZGyV8ckR4_vZshEjW90xPx6m43m6DWz3VBp7-5BC7Ru0GbMrFZd/exec";  // Your deployed Apps Script URL

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const phone = formData.get("phone");

      // Generate the Order ID
      const orderId = generateOrderId(phone);

      const cartItems = JSON.parse(localStorage.getItem("cart") || "[]");
      const itemsFormatted = cartItems.map(item => `${item.name} x${item.quantity}`);
      const totalAmount = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);

      const data = {
        "Order ID": orderId,
        "Name": formData.get("name"),
        "Email": formData.get("email"),
        "Phone": formData.get("phone"),
        "Pincode": formData.get("pincode"),
        "City": formData.get("city"),
        "State": formData.get("state"),
        "Floor/Flat No.": formData.get("floor"),
        "Street Name": formData.get("street"),
        "Area/Landmark": formData.get("area"),
        "Item Purchased": JSON.stringify(itemsFormatted),
        "Total": totalAmount
      };

      try {
        const res = await fetch(sheetURL, {
  method: "POST",
  body: JSON.stringify(data),
  headers: {
    "Content-Type": "application/json"
  },
  mode: "cors"  // Add a comma before 'mode'
});

        if (res.ok) {
          responseMsg.textContent = "✅ Order submitted successfully!";
          form.reset();
          localStorage.removeItem("cart");
        } else {
          responseMsg.textContent = "❌ Failed to submit order. Please try again.";
        }
      } catch (err) {
        responseMsg.textContent = "⚠️ Error connecting to server. Please check your internet.";
      }
    });
  </script>
</body>
</html>
